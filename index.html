<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Disposable Development environments with Azure DevOps and Azure Resource Manager</title>

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/beige.css">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/vs.css">

		<link rel="stylesheet" href="css/gc.css"/>

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section data-background-image="img/sqlbitsBranding.png"></section>
				<section><h2>Disposable Development environments</h2><h3>with Azure DevOps and Azure Resource Manager</h3>
				<hr/>
				<h4>Gavin Campbell</h4>
				<h4><a href="https://arapaima.uk">arapaima.uk</a></h4>
				<aside class="notes">Last thing before party<br/>End of a long day<br/>
				Who am I <br/>Many things<br/><br/>


				
				
			</aside>
				</section>

				

	
				<section>
					<img class = "plain stretch" src = "img/hourglass.jpg"/>
					<aside class="notes">
						Similar talks for 2-3 years <br/>
						Wasn't on SQLBits Agenda - Big Data and Paas<br/>
						Customers have this in prod now<br/>
						Not only about data<br/>
					</aside>
				</section>
				<section>
					<h4>Everything you ever wanted to know about Data Factory</h4>
					<img class = "plain stretch" src="img/big-picture.png"/>
					<br/>
				
					<cite><a href = "https://docs.microsoft.com/en-gb/azure/data-factory/introduction">docs.microsoft.com, Introduction to Data Factory</a></cite>
					<aside class = "notes">
						Not really SSIS for the Snapchat generation
					</aside>
				</section>

				<section>
					<h4>Everything you ever wanted to know about Data Factory</h4>

					<img class = "plain stretch " src="img/relationship-between-data-factory-entities.png"/>
					<cite><a href = "https://docs.microsoft.com/en-gb/azure/data-factory/introduction">docs.microsoft.com, Introduction to Data Factory</a></cite>
					<aside class = "notes">
						Not really SSIS for the Snapchat generation
					</aside>
				</section>

				<section>
					<h2>An Example Scenario</h2>
					<img class = "plain stretch" src = "img/overview.png"/>
					<aside class = "notes">
						Actual websites that do useful things<br/>
						Had to do some online research<br/>
						Channel 9</br>
						ALl about the...
					</aside>
				</section>
				<section>
					<h2>The Portal</h2>
					<img class = "plain stretch" src = "img/portal.jpg"/>
					<aside class = "notes">
						Transport through space and time<br/>
						Alternate dimension<br/>
						Ordinary rules don't apply<br/>
						In this case, the <b>cloud</b><br/>
						So how do we develop our ADF pipelines in the cloud?

					</aside>
				</section>
				<section>
					<h3>Developing ADF pipelines in the Portal</h3>
					<img class = "plain stretch" src = "img/dragNdrop.gif"/>
				</section>
				<section>
					<img class = "plain stretch" src = "img/noSaveOnlyPublish.png"/>
					<blockquote>Publish or Publish Not. There is No Save</blockquote>
				</section>
				<section>
					<img class = "plain stretch" src= "img/importExport.png"/>
				</section>
				<section>
					<h4>Unforced Paramaterisation</h4>
					<img class = "plain stretch" src= "img/params.gif" />
					<aside class="notes">
						Configuration over convention<br/>
						StackOverflow guy with 293 params<br/>
						Customer story - with V1 - can't tell the devs the secrets<br/>
						What was the name of the team that did this...
					</aside>
				</section>
				<section>
					<h4>Enterprise Scale</h4>
					<img class = "plain stretch" src= "img/moreDevelopers.jpg" />
				</section>
				<section>
					<h4>A tale of two developers</h4>
						<div class="grid2x2">
								<div><div><img src="img/step1.png" class="fragment"></div></div>
								<div><div><img src="img/step2.png" class="fragment"></div></div>
								<div><div><img src="img/step3.png" class="fragment"></div></div>
								<div><div><img src="img/step4.png" class="fragment"></div></div>
							  </div>
				</section>
				
					<section>
						<h4>What's missing from this picture?</h4>
						
						

					

					<div class="container">

							<div class="col">
									<img class = "plain fragment" src = "img/Git_icon.svg.png"/>
							</div>
							
							<div class="col">
									<blockquote class="fragment" >Source control is what allows us to scale beyond one developer.</blockquote>
							</div>
							
							</div>
							<aside class="notes">
								In the old days, BI solutions were developed by "that guy" in the corner.<br/>
								None of this stuff mattered<br/>
								It does now<br/>

								So, we're all cool with how git works, right?<br/>
							
							</aside>
					</section>

					<section>
							<img class = "plain stretch" src = "img/gitGetsEasier.png"/>
							<aside class = "notes">
								Seems complicated<br/>
								Solving a complicated problem<br/>
								Smart people - workflows - simplify the problem<br/>
								Reduce the surface area of git we need to know about to get work done<br/>
							</aside>
					</section>



					<section>
						<h5>git - the essentials</h5>
							<img class = "plain stretch" src = "img/featureworkflow.png"/>
							<aside class = "notes">
								If you want to know more about git..
							</aside>
					</section>

					<section>
							<img class = "plain stretch" src = "img/setUpCodeRepo.png"/>
					</section>

<section>
					<section>
					<h3>From the horse's mouth</h3>
						<small><i>Here is the entire lifecycle for continuous integration & delivery that you can use after you enable Azure Repos Git integration in the Data Factory UI:</i>
							<br/><br/>
					<ol >
<li> Set up a development data factory with Azure Repos in which all developers can author Data Factory resources like pipelines, datasets, and so forth.</li>
<li>Then developers can modify resources such as pipelines. As they make their modifications, they can select Debug to see how the pipeline runs with the most recent changes.</li>
<li>After developers are satisfied with their changes, they can create a pull request from their branch to the master branch (or the collaboration branch) to get their changes reviewed by peers.</li>
<li>After changes are in the master branch, they can publish to the development factory by selecting Publish.</li>
<li>When the team is ready to promote changes to the test factory and the production factory, they can export the Resource Manager template from the master branch, or from any other branch in case their master branch backs the live development Data Factory.</li>
<li>The exported Resource Manager template can be deployed with different parameter files to the test factory and the production factory.</li>
</ol></small>
<br/><br/>
<cite><a href="https://github.com/MicrosoftDocs/azure-docs/blob/93fec8e0932dcc45a7d1417c434bc17ffc874570/articles/data-factory/continuous-integration-deployment.md">docs.microsoft.com, Continuous integration and delivery (CI/CD) in Azure Data Factory</a></cite>
			
<aside class="notes">
	So what does this shared development sandbox look like?
</aside>

</section>
<section>
		<img class = "plain stretch" src = "img/meerkats.jpg"/>
		<aside class = "notes">
			Who here does - or did - SQL or BI dev on-prem?<br/>
			How much fun is it sharing a dev database with a bunch of other people?<br/>
			Any app devs? Monkey patching whilst debugging?<br/>
			<br/>

			Take the things that were a terrible idea on prem and "lift and shift" to the cloud.<br/>
			Let's see what this looks like in action...
		</aside>
</section>
</section>
	
		<section>
		<img class = "plain stretch" src = "img/changesSavedtoMaster.gif"/>
		</section>		

		<section>
				<img class = "plain stretch" src = "img/commitMessagesInMaster.png"/>
		</section>

		<section>
				<img class = "plain stretch" src = "img/protectingTheMasterBranch.png"/>
		</section>
		<section>
				<img class = "plain stretch" src = "img/cantSaveAnyMore.gif"/>
				<aside class = "notes">What does publish do anyway?</aside>
		</section>
				
		<section>
			<h4>Behind the scenes...</h4>

			<div class="container">

					<div class="col">
							<img class = "plain stretch fragment" src = "img/masterBranchStructure.png"/>
					</div>
					
					<div class="col">
							<img class = "plain stretch fragment" src = "img/adf_publishStructure.png"/>
					</div>
					
					</div>
					<aside class = "notes">
						Where is the USQL script file?<br/>
						Where are the other resources - the database, the buckets, the data lake accounts?<br/>
						Is "Data Lake Only Development" really a thing?<br/>
						Is this only useful for "Copy Data"?<br/>
						If those resources are in a different repo, how do we manage that dependency?<br/><br/>

						git submodules - buy a Peroni for everyone else here...

					</aside>
			</section>


		</section>

		<section>
			<blockquote>
				Developing abstractions intended to simplify the use of git source control rarely ends well.
			</blockquote>
		</section>


		<section>
			<h4>WHere do we go from here?</h4>
				<img class = "plain stretch" src = "img/forkInRoad.jpg"/>
				<aside class="notes">
					Is the portal a road to nowhere?<br/>
					3 years ago V1 of this talk and V1 of datafactory - this was much worse - Channel 9...<br/>
					Really wanted this to be good<br/>
					In-browser development is the future - things go wrong with desktops - and demos!<br/>
					However we are working, To add value, software needs to be deliverable<br/>
					Microsoft sales rep talking to CFO<br/>
					CFO says the Consultants told him everything must have DevOps <br/>
					Data Orchestration tool like Luigi - Spotify<br/>
					MS Loves open source? - but not that open source<br/>
					Well, we've got this thing called data factory, we'll just RubDevOpsOnIt<br/><br/>
					So what do we do? Turns out the answer is right here...

				</aside>
		</section>



		<section>
			<h3>ARM Templates</h3>
			<img class = "plain stretch" src = "img/armtemplate.png"/>

			<aside class="notes">
				In the adf publish branch we have everything we need<br/>
				Including the config :-(<br/>
				Mentioned this thing called ARM templates without defining it...

			</aside>

		</section>

		<section>
			<h3>ARM Templates</h3>
			<b>Template deployment</b>
			<blockquote>With Resource Manager, you can create a template (in JSON format) that defines the infrastructure and configuration of your Azure solution. By using a template, you can repeatedly deploy your solution throughout its lifecycle and have confidence your resources are deployed in a consistent state.</blockquote>
			<cite><a href = "https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-group-overview#template-deployment">docs.microsoft.com, Resource Manager</a></cite>	
		</section>

		<section>
				<h3>ARM Templates</h3>
				<img class = "plain stretch" src = "img/arm4vsCode.png"/>
		
		</section>

		<section>
			<h4>All our resources are defined in the same place</h4>
			<img class = "plain stretch" src = "img/adfInVsCode.png"/>
		</section>

		<section>
			<pre><code data-trim class="stretch">
					{
						"name": "[parameters('adlsAccountName')]",
						"type": "Microsoft.DataLakeStore/accounts",
				
						"apiVersion": "2016-11-01",
						"location": "[resourceGroup().location]",
						"scale": null,
						"properties": {},
						"dependsOn": [],
						"resources":[
							{
								"type": "Microsoft.DataLakeStore/accounts/providers/roleAssignments",
								"apiVersion": "2017-05-01",
								"name": "[concat(parameters('adlsAccountName'), '/Microsoft.Authorization/', guid(resourceId('Microsoft.DataLakeStore/accounts', parameters('adlsAccountName'))))]",
								"dependsOn": [
									"[resourceId('Microsoft.DataLakeStore/accounts', parameters('adlsAccountName'))]"
								  ],
								"properties": {
								"roleDefinitionId": "[variables('readerRoleDefinition')]",
								"principalId": "[reference(concat('Microsoft.DataFactory/factories/', parameters('dataFactoryName')), '2018-06-01', 'Full').identity.principalId]"
									

			</code></pre>
		</section>

		<section>
			<pre><code data-trim class = "stretch">
					"parameters": {
						"storageAccountName": {
							"type": "string",
							"defaultValue": "[concat('kebabstor', uniqueString(resourceGroup().id))]"
						},
						"adlsAccountName": {
							"type": "string",
							"defaultValue": "[concat('kebabadls', uniqueString(resourceGroup().id))]"
						},
						"adfApplicationId":{
							"type": "string"
				
						},
						"adfApplicationKey":{
							"type": "securestring"
				
						},
						"dwServerName": {
							"type": "string",
							"defaultValue": "[concat('kebabDwServer', uniqueString(resourceGroup().id))]"
						},  

						"dwTierName":{
							"type": "string",
							"defaultValue": "DW100c"
						}
					}

			</code></pre>
		</section>
		<section>
			<h4>Resources deployed to Azure</h4>
			<img class="plain stretch" src="img/resourcesDeployedToAzure.png"/>
			<aside class="notes">But how did they get there?</aside>
		</section>

		<section data-background="img/devopsName.jpg" data-background-size="contain"></section>

		<section data-transition="none">
			<h3>The Build Definition</h3>
			<img class = "plain stretch" src = "img/builddefinition.png"/>

		</section>

		<section  data-transition="none">
				<h3>The Build Definition</h3>
				<img class = "plain stretch" src = "img/builddefinitionRgNameHighlighted.png"/>
	
		</section>

		<section>
			<h3>The Build Trigger</h3>
			<img class = "plain stretch" src = "img/buildtriggers.png"/>
		</section>

		<section>
			<h3>Creating a branch</h3>
			<img class = "plain stretch" src = "img/citrigger.gif"/>

		</section>
		<section>
			<h4>The tests were passing when the branch was created...</h4>
			<img class = "plain stretch" src="img/testsPassed.png"/>
				
		</section>

		<section>
			<h3>A dedicated environment for this branch</h3>
			<img class = "plain stretch" src = "img/resourceGroupForFeatureBranch.png"/>
		</section>

		<section>
			<h3>Debugging the Data Factory</h3>
			<img class = "plain stretch" src = "img/dedicateddatafactory.png"/>

		</section>

		<section>
			<h3>Completing the feature</h3>
			<img class = "plain stretch" src = "img/creatingApullRequest.png"/>
		</section>

		<section>
			<h3>Merging the feature</h3>
			<img class = "plain stretch" src = "img/mergingThePullRequest.png"/>
		</section>

		<section>
			<h3>Service Hooks</h3>
			<img class = "plain stretch" src = "img/serviceHookStep0.png"/>
		</section>
		<section>
			<h3>Service Hooks</h3>
			<img class = "plain stretch" src = "img/serviceHookStep1.png"/>
		</section>
		<section>
			<h3>Service Hooks</h3>
			<img class = "plain stretch" src = "img/serviceHookStep2.png"/>
		</section>	
		<section data-transition="in-slide out-none"> 
			<h3>Service Hooks</h3>
			<img class = "plain stretch" src = "img/serviceHookStep3.png"/>
		</section>	
		<section data-transition="in-none out-slide">
				<h3>Service Hooks</h3>
				<img class = "plain stretch" src = "img/serviceHookStep3Highlighted.png"/>
		</section>	
		<section>
			<h3>Meanwhile, in Azure Automation</h3>
			<img class = "plain stretch" src="img/createwebhook.png"/>
		</section>	
		<section>
				<h3>The Terminator</h3>
				<img class = "plain stretch" src="img/createRunbook.png"/>
		</section>	
		<section>
				<h3>Completing the pull request...</h3>
				<img class = "plain stretch" src="img/prcompleted.png"/>
		</section>	
		<section>
				<h3>...triggers the runbook...</h3>
				<img class = "plain stretch" src="img/runbookRunning.png"/>
		</section>	
		<section>
				<h3>...which deletes the resource group</h3>
				<img class = "plain stretch" src="img/resourceGroupDeleting.png"/>
		</section>	
		<section>
				<h3>We also build and deploy the master branch...</h3>
				<img class = "plain stretch" src="img/deployingMasterAfterPRMerge.png"/>
				
		</section>
		<section>
			<h3>THe "master" resource group</h3>
			<img class = "plain stretch" src="img/masterResourceGroup.png"/>
		</section>
		<section>
				<h3>...and run our tests...</h3>
				<img class = "plain stretch" src="img/testspassedinMaster.png"/>
		</section>
		<section>
				<h3>...and save the build artefacts</h3>
				<img class = "plain stretch" src="img/builddefinitionPublishStep.png"/>
		</section>
		<section>
			<h3>Release Management</h3>
			<img class = "plain stretch" src="img/releasePipeline.png"/>

		</section>
		<section>
			<h3>Release to Staging</h3>
			<img class = "plain stretch" src="img/releaseToStaging.png"/>
			
		</section>
		<section>
			<h3>Hang on a minute...</h3>
			<img class = "plain stretch" src="img/predeployapproval.png"/>
		</section>
		<section>
			<h3>Release to Production</h3>
			<img class = "plain stretch" src="img/productionparams.png"/>
		</section>
		<section>
			<h4>Summary</h4>
			
			<img class = "plain stretch" src="img/overallflow.png"/>

		</section>
		<section data-transition="zoom">
			<h1>
			Audience participation...
			</h1>
		
		
		</section>


						
		







			</div>
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>
			// More info about config & dependencies:
			// - https://github.com/hakimel/reveal.js#configuration
			// - https://github.com/hakimel/reveal.js#dependencies
			Reveal.initialize({
				width: 1920,
				height: 1080,
				slideNumber: "c/t",
				dependencies: [
					{ src: 'plugin/markdown/marked.js' },
					{ src: 'plugin/markdown/markdown.js' },
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
				]
			});
		</script>
	</body>
</html>
